WITH historical_data as

(select
four_year_historical_data.period AS "Period",	
sum(four_year_historical_data.assigned_count) AS "Asgn #",
sum(four_year_historical_data.assigned_value) AS "Asgn $",	
sum(four_year_historical_data.assigned_average) AS "Asgn Avg",	
sum(four_year_historical_data.collected_current_value) AS "Coll Curr",	
sum(four_year_historical_data.collected_current_percentage) AS "Coll Curr %",	
sum(four_year_historical_data.collected_to_date) AS "Coll To Date",	
sum(four_year_historical_data.collected_to_date_percentage) AS "Coll To Date %",	
sum(four_year_historical_data.commission_to_date) AS "Comm To Date",	
sum(four_year_historical_data.commission_percentage) AS "Comm %",	
sum(four_year_historical_data.cancel_count) AS "Cancel #",	
sum(four_year_historical_data.cancel_value) AS "Cancel $",	
sum(four_year_historical_data.cancel_percentage) AS "Cancel %",	
sum(four_year_historical_data.open_count) AS "Open #",	
sum(four_year_historical_data.open_value) AS "Open $",	
sum(four_year_historical_data.pif_count) AS "# PIF"	,
sum(four_year_historical_data.sif_count) AS "#SIF",
(row_number() over(order by four_year_historical_data.period))-84 as sortorder
from four_year_historical_data, client
where 
four_year_historical_data.client_id = client.client_id
AND client.customer_client_code = '${String:ClientCode}'
AND TO_DATE(four_year_historical_data.period, 'YYYY-MM') < (DATE_TRUNC('month', ${DateTime:Date}) - INTERVAL '4 years')
group by four_year_historical_data.period

union

select
TO_CHAR(client_summary.month,'Mon YYYY') "Period",	
sum(client_summary.placement_count) "Asgn #",
sum(client_summary.assigned_balance) "Asgn $",	
case when sum(client_summary.placement_count)=0 then 0 else round(sum(client_summary.assigned_balance)/sum(client_summary.placement_count),0) end "Asgn Avg",	
sum(client_summary.current_balance) "Coll Curr",	
case when sum(client_summary.assigned_balance)=0 then 0 else sum(client_summary.current_balance)/sum(client_summary.assigned_balance)/100 end "Coll Curr %",	
sum(client_summary.payments) "Coll To Date",	
case when sum(client_summary.assigned_balance)=0 then 0 else sum(client_summary.payments)/sum(client_summary.assigned_balance) end "Coll To Date %",	
sum(client_summary.commissions) "Comm To Date",	
case when sum(client_summary.assigned_balance)=0 then 0 else sum(client_summary.commissions)/sum(client_summary.assigned_balance) * 100 end "Comm %",	
sum(client_summary.cancelled) "Cancel #",	
sum(client_summary.cancelled_balance) "Cancel $",	
case when sum(client_summary.assigned_balance)=0 then 0 else sum(client_summary.cancelled_balance)/sum(client_summary.assigned_balance) / 100 end "Cancel %",	
sum(client_summary.open) "Open #",	
sum(client_summary.owing_balance) "Open $",	
sum(client_summary.pif) "# PIF"	,

sum(client_summary.sif) "#SIF",
(row_number() over(order by client_summary.month))-48 as sortorder
from client_summary
where client_summary.customer_client_code = '${String:ClientCode}'
AND client_summary.month BETWEEN
        (DATE_TRUNC('month', ${DateTime:Date}) - INTERVAL '1 years') AND
        (DATE_TRUNC('month', ${DateTime:Date}))
group by client_summary.month
) 
select 
"Period", "Asgn #", "Asgn $" as "Currency:Asgn $"	,"Asgn Avg"	,"Coll Curr"	,"Coll Curr %"	,"Coll To Date"	,"Coll To Date %"	,"Comm To Date" as "Currency:Comm To Date"	,"Comm %"	,"Cancel #"	,"Cancel $" as "Currency:Cancel $"	,"Cancel %"	,"Open #"	,"Open $" as "Currency:Open $"	,"# PIF"	,"#SIF", sortorder
from historical_data
order by sortorder